(ns neuhon.markov
  ^{:doc "Markov chains for temporal analysis of tonality variations"
    :author "Antoine Passemiers"}
  (:gen-class)
  (:require [clojure.java.io :as io])
  (:use [clojure.java.io]
        [clojure.core.matrix]
        [neuhon.matrix]
        [neuhon.utils]))


;; 106 202 224

;; (24x24) matrix where the (i, j) element is the transition probability
;; between key i and key j
(def transition-probs
  (object-array
    [[0.48407405,  0.04311577,  0.02667937,  0.03665011,  0.01296536,
      0.03787518,  0.00585313,  0.02912952,  0.02038386,  0.01429252,
      0.01405431,  0.00660178,  0.01439461,  0.01320357,  0.00517253,
      0.01827401,  0.00643163,  0.03123937,  0.00626149,  0.04233308,
      0.03753488,  0.02171102,  0.04815218,  0.02361669], 
    [ 0.19500465,  0.27598511,  0.05243562,  0.04545455,  0.02032268,
      0.02807943,  0.01737512,  0.01504809,  0.01923674,  0.0217189 ,
      0.01582377,  0.01365188,  0.01442755,  0.02373565,  0.01210053,
      0.01116972,  0.01970214,  0.02140863,  0.03071672,  0.01923674,
      0.03537077,  0.02637294,  0.03645672,  0.02916537],
    [ 0.16465939,  0.06473466,  0.22224313,  0.06511103,  0.03368461,
      0.05513737,  0.03029733,  0.03123824,  0.01185548,  0.01693639,
      0.01467821,  0.01787731,  0.02258186,  0.02182913,  0.01467821,
      0.01505457,  0.01223184,  0.03368461,  0.01637185,  0.03368461,
      0.02916823,  0.02916823,  0.02182913,  0.02126458],
    [ 0.14577214,  0.04019168,  0.06353378,  0.23496676,  0.05147627,
      0.09475962,  0.02086876,  0.02859793,  0.03277168,  0.00958417,
      0.01855001,  0.01267584,  0.02102334,  0.02612459,  0.00757459,
      0.01715876,  0.01143917,  0.02566084,  0.00942959,  0.02179626,
      0.03246251,  0.02133251,  0.0363271 ,  0.01592209], 
    [ 0.11769912,  0.04011799,  0.06047198,  0.10412979,  0.19882006,
      0.10589971,  0.02861357,  0.0339233 ,  0.01386431,  0.01976401,
      0.00560472,  0.0120944 ,  0.03126844,  0.02861357,  0.01917404,
      0.01887906,  0.01120944,  0.02300885,  0.01474926,  0.0339233 ,
      0.02035398,  0.01828909,  0.02271386,  0.01681416], 
    [ 0.16349481,  0.02174988,  0.0338606 ,  0.06117153,  0.04609491,
      0.29424123,  0.01940188,  0.04930796,  0.02446861,  0.01804251,
      0.01853683,  0.00457242,  0.0239743 ,  0.01952546,  0.01272862,
      0.0145823 ,  0.01594167,  0.02582798,  0.01149283,  0.02249135,
      0.04003955,  0.01532378,  0.03262481,  0.0105042 ], 
    [ 0.0858989 ,  0.04979095,  0.0440897 ,  0.04028886,  0.03990878,
      0.07791714,  0.17293805,  0.06119346,  0.03192702,  0.0231851 ,
      0.02432535,  0.01140251,  0.01140251,  0.01938426,  0.0186241 ,
      0.01482326,  0.0254656 ,  0.02470544,  0.02964652,  0.03306727,
      0.05169137,  0.03648803,  0.04332953,  0.02850627], 
    [ 0.12814856,  0.0163633 ,  0.04026475,  0.03566832,  0.02334988,
      0.07243979,  0.03419746,  0.26218055,  0.07115279,  0.03125575,
      0.0301526 ,  0.00937672,  0.03254275,  0.01158301,  0.01930502,
      0.01489244,  0.01709873,  0.02059202,  0.01231844,  0.01985659,
      0.02151131,  0.01489244,  0.04081633,  0.02004045], 
    [ 0.12993421,  0.02443609,  0.01621241,  0.04769737,  0.01550752,
      0.04816729,  0.01926692,  0.0700188 ,  0.2868891 ,  0.03242481,
      0.03265977,  0.0093985 ,  0.01621241,  0.01104323,  0.00634398,
      0.01926692,  0.01903195,  0.03289474,  0.01574248,  0.02725564,
      0.0256109 ,  0.0256109 ,  0.04511278,  0.02326128], 
    [ 0.13939981,  0.04614392,  0.02775089,  0.02420136,  0.02452404,
      0.03775411,  0.01323007,  0.06034205,  0.03904485,  0.160697  ,
      0.0529203 ,  0.02226525,  0.07454017,  0.02000645,  0.02420136,
      0.01613424,  0.03000968,  0.04420781,  0.01871571,  0.01968377,
      0.03130042,  0.0232333 ,  0.0316231 ,  0.01807035], 
    [ 0.14686684,  0.0345953 ,  0.03165796,  0.03198433,  0.00913838,
      0.05450392,  0.0189295 ,  0.03296345,  0.04634465,  0.04601828,
      0.29079634,  0.01533943,  0.04144909,  0.01762402,  0.00815927,
      0.01207572,  0.00750653,  0.02415144,  0.01109661,  0.02480418,
      0.01697128,  0.02937337,  0.03035248,  0.01729765],
    [ 0.12659769,  0.0499087 ,  0.04260499,  0.05234327,  0.02495435,
      0.03043214,  0.02191114,  0.02556299,  0.02191114,  0.04321363,
      0.02069385,  0.17528911,  0.0584297 ,  0.04686549,  0.02617164,
      0.01521607,  0.02434571,  0.02556299,  0.02617164,  0.02921485,
      0.02556299,  0.01765064,  0.03530128,  0.03408399],
    [ 0.08136899,  0.01881233,  0.02629193,  0.03626473,  0.02062557,
      0.05009066,  0.01110607,  0.04306437,  0.01631913,  0.05961015,
      0.03082502,  0.01971895,  0.31300997,  0.02561197,  0.024932  ,
      0.02425204,  0.02153218,  0.05099728,  0.012466  ,  0.03127833,
      0.02697189,  0.02266546,  0.01518586,  0.01699909],
    [ 0.13478916,  0.05233434,  0.03652108,  0.05082831,  0.0372741 ,
      0.05760542,  0.02597892,  0.02936747,  0.02183735,  0.01957831,
      0.01618976,  0.02033133,  0.0496988 ,  0.11671687,  0.01618976,
      0.03915663,  0.02673193,  0.03463855,  0.01581325,  0.02447289,
      0.07756024,  0.02710843,  0.04631024,  0.02296687],
    [ 0.06318083,  0.03529412,  0.02832244,  0.0204793 ,  0.02570806,
      0.05315904,  0.02570806,  0.05359477,  0.01132898,  0.03006536,
      0.016122  ,  0.01917211,  0.04052288,  0.0204793 ,  0.29934641,
      0.03006536,  0.0335512 ,  0.0496732 ,  0.02135076,  0.04052288,
      0.01568627,  0.02135076,  0.02222222,  0.02309368],
    [ 0.16692096,  0.02502289,  0.03173634,  0.03173634,  0.01861459,
      0.03265182,  0.01434239,  0.02441257,  0.02197132,  0.01098566,
      0.00976503,  0.00945987,  0.0384498 ,  0.02868477,  0.02502289,
      0.19621605,  0.0256332 ,  0.10649985,  0.01678364,  0.0405859 ,
      0.04943546,  0.0170888 ,  0.04516326,  0.0128166 ],
    [ 0.09049959,  0.04914005,  0.03153153,  0.03357903,  0.01965602,
      0.04873055,  0.03112203,  0.04422604,  0.02457002,  0.03194103,
      0.01105651,  0.01228501,  0.04422604,  0.03235053,  0.04299754,
      0.03480753,  0.15765766,  0.07944308,  0.02538903,  0.04791155,
      0.03194103,  0.02620803,  0.02538903,  0.02334152],
    [ 0.13841481,  0.02386462,  0.03167486,  0.02458779,  0.01026902,
      0.0263234 ,  0.00781024,  0.01880243,  0.01605438,  0.01489731,
      0.01489731,  0.0072317 ,  0.02617877,  0.01778999,  0.01663292,
      0.03760486,  0.03210876,  0.30416546,  0.03109633,  0.06754411,
      0.05539485,  0.02719121,  0.04136535,  0.00809951],
    [ 0.07551669,  0.04610493,  0.02424483,  0.02384738,  0.0190779 ,
      0.03020668,  0.03696343,  0.03259141,  0.02384738,  0.01709062,
      0.01311606,  0.02106518,  0.0190779 ,  0.01709062,  0.02146264,
      0.04411765,  0.02305246,  0.07392687,  0.20349762,  0.04809221,
      0.04928458,  0.03418124,  0.05643879,  0.04610493],
    [ 0.18947046,  0.0228038 ,  0.02770125,  0.02938476,  0.01484542,
      0.03275176,  0.01622283,  0.01836547,  0.0157637 ,  0.0120906 ,
      0.01132537,  0.00734619,  0.02494643,  0.00841751,  0.01147842,
      0.02800735,  0.0157637 ,  0.05892256,  0.01714111,  0.27058463,
      0.05984083,  0.03397612,  0.05157637,  0.02127334],
    [ 0.12302747,  0.03784337,  0.01870251,  0.03082992,  0.0163647 ,
      0.04865576,  0.01504968,  0.01651081,  0.01957919,  0.01665693,
      0.00935126,  0.00686733,  0.02177089,  0.01957919,  0.00628288,
      0.02191701,  0.01475745,  0.06136762,  0.01592636,  0.06779661,
      0.28375219,  0.03623612,  0.07495617,  0.01621859],
    [ 0.14966822,  0.04227083,  0.02949128,  0.02629639,  0.01867781,
      0.04128779,  0.02236422,  0.02801671,  0.02162694,  0.02236422,
      0.01327107,  0.00614402,  0.0231015 ,  0.01671172,  0.01253379,
      0.017449  ,  0.02678791,  0.0405505 ,  0.01916933,  0.05627918,
      0.06266896,  0.19931187,  0.05922831,  0.04472843],
    [ 0.21432757,  0.03926165,  0.02036332,  0.03515968,  0.0109874 ,
      0.0335482 ,  0.01640785,  0.02593027,  0.0219748 ,  0.01318488,
      0.01289188,  0.00937592,  0.01186639,  0.01743334,  0.00849692,
      0.02094931,  0.00937592,  0.05405801,  0.02080281,  0.04980955,
      0.0559625 ,  0.03808966,  0.21681805,  0.04292411],
    [ 0.24599407,  0.0578635 ,  0.04658754,  0.03382789,  0.01454006,
      0.0272997 ,  0.01988131,  0.02789318,  0.02759644,  0.02225519,
      0.01305638,  0.01513353,  0.01869436,  0.01246291,  0.00979228,
      0.0148368 ,  0.01691395,  0.01691395,  0.02166172,  0.03649852,
      0.03679525,  0.04272997,  0.07418398,  0.14658754]]))

(defn rotate-key-index
  "Rotates the index of the key"
  [k shift]
  (mod (+ k (- 24 shift)) 24))

(defn evaluate-ith-key
  "Computes the log-probability of the sequence conditional
  to the ith key"
  [observations ith]
  (apply-sum
    (mapv
      #(log_2
        (mget
          transition-probs
          (rotate-key-index (nth observations (- %1 1)) ith)
          (rotate-key-index (nth observations %1) ith)))
      (range 1 (count observations)))))

(defn most-probable-key
  "Returns the index of the most probable key, considering
  the input sequence as a markov chain with known transition probabilities"
  [observations]
  (arg-max
    (mapv
      #(evaluate-ith-key observations %1)
      (range 24))))